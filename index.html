<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rama SDA School - Exam Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'school-blue': '#1e3a8a',
                        'school-gold': '#f59e0b'
                    }
                }
            }
        }
    </script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { font-size: 12px; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen">
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <!-- Header -->
    <header class="bg-school-blue text-white p-4 shadow-lg no-print">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-16 h-16 bg-school-gold rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-school-blue" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 3L1 9L12 15L21 10.09V17H23V9M5 13.18V17.18L12 21L19 17.18V13.18L12 17L5 13.18Z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">RAMA SDA SCHOOL</h1>
                    <p class="text-sm text-blue-200">Exam Management System</p>
                    <p class="text-xs text-blue-300">Motto: "In God We Can"</p>
                </div>
            </div>
            <div class="text-right text-sm">
                <p>P.O. BOX 44-50201, CHEPTAIS</p>
                <p>ramasdaprimary@gmail.com</p>
                <p id="currentUser" class="text-blue-200 mt-2">Welcome, Admin</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-4">
        <!-- Dashboard View -->
        <div id="dashboard" class="view">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Dashboard</h2>
                
                <!-- Action Buttons Grid -->
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <button onclick="showView('registerStudent')" class="bg-primary hover:bg-blue-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">👥</div>
                        <div class="font-semibold">Register Learner</div>
                    </button>
                    
                    <button onclick="showView('registerTeacher')" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">👨‍🏫</div>
                        <div class="font-semibold">Register Facilitator</div>
                    </button>
                    
                    <button onclick="showView('gradeList')" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">📋</div>
                        <div class="font-semibold">Grade List</div>
                    </button>
                    
                    <button onclick="showView('promoteStudents')" class="bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">⬆️</div>
                        <div class="font-semibold">Promote Students</div>
                    </button>
                    
                    <button onclick="showView('termDates')" class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">📅</div>
                        <div class="font-semibold">Term & Dates</div>
                    </button>
                    
                    <button onclick="showView('markEntry')" class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">✏️</div>
                        <div class="font-semibold">Mark Entry</div>
                    </button>
                    
                    <button onclick="showView('generateMarksheets')" class="bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">📄</div>
                        <div class="font-semibold">Generate Marksheets</div>
                    </button>
                    
                    <button onclick="showView('broadsheets')" class="bg-teal-600 hover:bg-teal-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">📊</div>
                        <div class="font-semibold">Broadsheets</div>
                    </button>
                    
                    <button onclick="showView('reportCards')" class="bg-pink-600 hover:bg-pink-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">🎓</div>
                        <div class="font-semibold">Report Cards</div>
                    </button>
                    
                    <button onclick="freshSystem()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">🔄</div>
                        <div class="font-semibold">Fresh System</div>
                    </button>
                    
                    <button onclick="logout()" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-lg text-center transition-colors">
                        <div class="text-2xl mb-2">🚪</div>
                        <div class="font-semibold">Logout</div>
                    </button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Total Students</h3>
                    <p id="totalStudents" class="text-3xl font-bold text-primary">0</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Total Teachers</h3>
                    <p id="totalTeachers" class="text-3xl font-bold text-green-600">0</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Active Grades</h3>
                    <p id="activeGrades" class="text-3xl font-bold text-blue-600">11</p>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Current Term</h3>
                    <p id="currentTerm" class="text-3xl font-bold text-orange-600">Term 1</p>
                </div>
            </div>
        </div>

        <!-- Register Student View -->
        <div id="registerStudent" class="view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Register Learner</h2>
                    <button onclick="showView('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Back to Dashboard
                    </button>
                </div>

                <form id="studentForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Admission Number *</label>
                        <input type="text" id="admissionNumber" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assessment Number (Optional)</label>
                        <input type="text" id="assessmentNumber" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name *</label>
                        <input type="text" id="studentName" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Gender *</label>
                        <select id="gender" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Section *</label>
                        <select id="section" required onchange="updateGrades()" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Select Section</option>
                            <option value="PRE-PRIMARY">PRE-PRIMARY</option>
                            <option value="LOWER PRIMARY">LOWER PRIMARY</option>
                            <option value="UPPER PRIMARY">UPPER PRIMARY</option>
                            <option value="JUNIOR SCHOOL">JUNIOR SCHOOL</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Grade *</label>
                        <select id="grade" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Select Grade</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Year of Admission *</label>
                        <input type="number" id="yearOfAdmission" required min="2020" max="2030" value="2024" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>

                    <div class="md:col-span-2 flex space-x-4">
                        <button type="submit" class="bg-primary hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold">
                            Register Learner
                        </button>
                        <button type="reset" onclick="resetStudentForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold">
                            Clear Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Register Teacher View -->
        <div id="registerTeacher" class="view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Register Facilitator</h2>
                    <button onclick="showView('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Back to Dashboard
                    </button>
                </div>

                <form id="teacherForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Facilitator Name *</label>
                        <input type="text" id="teacherName" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Role(s) in School *</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center">
                                <input type="checkbox" value="HEAD OF INSTITUTION" class="teacher-role mr-2">
                                <span class="dark:text-gray-300">Head of Institution</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="DEPUTY HEAD OF INSTITUTION" class="teacher-role mr-2">
                                <span class="dark:text-gray-300">Deputy Head of Institution</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="SENIOR TEACHER" class="teacher-role mr-2">
                                <span class="dark:text-gray-300">Senior Teacher</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="GRADE FACILITATOR" class="teacher-role mr-2" onchange="toggleGradeSelector(this)">
                                <span class="dark:text-gray-300">Grade Facilitator</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="SUBJECT TEACHER" class="teacher-role mr-2" onchange="toggleSubjectSelector(this)">
                                <span class="dark:text-gray-300">Subject Teacher</span>
                            </label>
                        </div>
                    </div>

                    <div id="gradeSelector" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Grade Facilitating</label>
                        <select id="facilitatingGrade" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Select Grade</option>
                            <option value="PP1">PP1</option>
                            <option value="PP2">PP2</option>
                            <option value="Grade 1">Grade 1</option>
                            <option value="Grade 2">Grade 2</option>
                            <option value="Grade 3">Grade 3</option>
                            <option value="Grade 4">Grade 4</option>
                            <option value="Grade 5">Grade 5</option>
                            <option value="Grade 6">Grade 6</option>
                            <option value="Grade 7">Grade 7</option>
                            <option value="Grade 8">Grade 8</option>
                            <option value="Grade 9">Grade 9</option>
                        </select>
                    </div>

                    <div id="subjectSelector" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Learning Areas Teaching</label>
                        <div id="learningAreas" class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <!-- Learning areas will be populated based on grade selection -->
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
                            Register Facilitator
                        </button>
                        <button type="reset" onclick="resetTeacherForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold">
                            Clear Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Grade List View -->
        <div id="gradeList" class="view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Grade List</h2>
                    <button onclick="showView('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Back to Dashboard
                    </button>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Select Grade</label>
                    <div class="flex space-x-4">
                        <select id="gradeListSelector" class="flex-1 px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Select Grade</option>
                            <option value="PP1">PP1</option>
                            <option value="PP2">PP2</option>
                            <option value="Grade 1">Grade 1</option>
                            <option value="Grade 2">Grade 2</option>
                            <option value="Grade 3">Grade 3</option>
                            <option value="Grade 4">Grade 4</option>
                            <option value="Grade 5">Grade 5</option>
                            <option value="Grade 6">Grade 6</option>
                            <option value="Grade 7">Grade 7</option>
                            <option value="Grade 8">Grade 8</option>
                            <option value="Grade 9">Grade 9</option>
                        </select>
                        <button onclick="loadGradeList()" class="bg-primary hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                            Load List
                        </button>
                    </div>
                </div>

                <div id="gradeListContent" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                            <thead>
                                <tr class="bg-gray-50 dark:bg-gray-700">
                                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">S/No</th>
                                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Admission No.</th>
                                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Assessment No.</th>
                                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Name</th>
                                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Gender</th>
                                    <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Signature</th>
                                </tr>
                            </thead>
                            <tbody id="gradeListTable">
                                <!-- Table content will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Promote Students View -->
        <div id="promoteStudents" class="view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Promote Students</h2>
                    <button onclick="showView('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Back to Dashboard
                    </button>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">From Grade</label>
                            <select id="promoteFromGrade" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Grade</option>
                                <option value="PP1">PP1</option>
                                <option value="PP2">PP2</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">To Grade</label>
                            <select id="promoteToGrade" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Grade</option>
                                <option value="PP2">PP2</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="Grade 9">Grade 9</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Academic Year</label>
                            <input type="number" id="promoteYear" min="2020" max="2030" value="2025" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="loadStudentsForPromotion()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                            Load Students
                        </button>
                        <button onclick="promoteSelectedStudents()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg">
                            Promote Selected
                        </button>
                        <button onclick="promoteAllStudents()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg">
                            Promote All
                        </button>
                    </div>

                    <div id="promotionStudentsList" class="hidden">
                        <h3 class="text-lg font-semibold mb-4 dark:text-white">Students for Promotion</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                                <thead>
                                    <tr class="bg-gray-50 dark:bg-gray-700">
                                        <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left">
                                            <input type="checkbox" id="selectAllPromote" onchange="toggleAllPromoteSelection()">
                                        </th>
                                        <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Admission No.</th>
                                        <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Name</th>
                                        <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Current Grade</th>
                                        <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Gender</th>
                                    </tr>
                                </thead>
                                <tbody id="promotionTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Term and Dates View -->
        <div id="termDates" class="view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Term and Dates Management</h2>
                    <button onclick="showView('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Back to Dashboard
                    </button>
                </div>

                <form id="termForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Term *</label>
                            <select id="termSelect" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Term</option>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Academic Year *</label>
                            <input type="number" id="termYear" required min="2020" max="2030" value="2024" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Opening Date *</label>
                            <input type="date" id="openingDate" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Closing Date *</label>
                            <input type="date" id="closingDate" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg">
                            Save Term Dates
                        </button>
                        <button type="reset" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg">
                            Clear Form
                        </button>
                    </div>
                </form>

                <!-- Existing Terms -->
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-4 dark:text-white">Existing Terms</h3>
                    <div id="existingTerms" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Terms will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Mark Entry View -->
        <div id="markEntry" class="view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Mark Entry</h2>
                    <button onclick="showView('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Back to Dashboard
                    </button>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Academic Year</label>
                            <input type="number" id="markEntryYear" min="2020" max="2030" value="2024" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Grade</label>
                            <select id="markEntryGrade" onchange="loadLearningAreasForMarks()" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Grade</option>
                                <option value="PP1">PP1</option>
                                <option value="PP2">PP2</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="Grade 9">Grade 9</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Term</label>
                            <select id="markEntryTerm" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Term</option>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exam Type</label>
                            <select id="markEntryExamType" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Exam Type</option>
                                <option value="Midterm">Midterm</option>
                                <option value="Endterm">Endterm</option>
                            </select>
                        </div>
                    </div>

                    <div id="learningAreaSelection" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Learning Area</label>
                        <select id="markEntryLearningArea" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="">Select Learning Area</option>
                        </select>
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="loadStudentsForMarks()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                            Load Students
                        </button>
                        <button onclick="submitMarks()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg" style="display: none;" id="submitMarksBtn">
                            Submit Marks
                        </button>
                    </div>

                    <div id="markEntryTable" class="hidden">
                        <h3 class="text-lg font-semibold mb-4 dark:text-white">Enter Marks</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300 dark:border-gray-600">
                                <thead>
                                    <tr class="bg-gray-50 dark:bg-gray-700">
                                        <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">S/No</th>
                                        <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Admission No.</th>
                                        <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Name</th>
                                        <th class="border border-gray-300 dark:border-gray-600 px-4 py-2 text-left dark:text-white">Mark (0-100)</th>
                                    </tr>
                                </thead>
                                <tbody id="markEntryTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generate Marksheets View -->
        <div id="generateMarksheets" class="view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Generate Marksheets</h2>
                    <button onclick="showView('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Back to Dashboard
                    </button>
                </div>

                <form id="marksheetForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Grade *</label>
                            <select id="marksheetGrade" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Grade</option>
                                <option value="PP1">PP1</option>
                                <option value="PP2">PP2</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="Grade 9">Grade 9</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Academic Year *</label>
                            <input type="number" id="marksheetYear" required min="2020" max="2030" value="2024" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Term *</label>
                            <select id="marksheetTerm" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Term</option>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type of Exam *</label>
                            <select id="marksheetExamType" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Exam Type</option>
                                <option value="Midterm">Midterm</option>
                                <option value="Endterm">Endterm</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg">
                            Generate & Print Marksheet
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Broadsheets View -->
        <div id="broadsheets" class="view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Broadsheets</h2>
                    <button onclick="showView('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Back to Dashboard
                    </button>
                </div>

                <form id="broadsheetForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Grade *</label>
                            <select id="broadsheetGrade" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Grade</option>
                                <option value="PP1">PP1</option>
                                <option value="PP2">PP2</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="Grade 9">Grade 9</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Academic Year *</label>
                            <input type="number" id="broadsheetYear" required min="2020" max="2030" value="2024" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Term *</label>
                            <select id="broadsheetTerm" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Term</option>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type of Exam *</label>
                            <select id="broadsheetExamType" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Exam Type</option>
                                <option value="Midterm">Midterm</option>
                                <option value="Endterm">Endterm</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg">
                            Generate Broadsheet
                        </button>
                        <button type="button" onclick="printBroadsheet()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg" style="display: none;" id="printBroadsheetBtn">
                            Print Broadsheet
                        </button>
                    </div>
                </form>

                <div id="broadsheetContent" class="hidden mt-8">
                    <!-- Broadsheet content will be generated here -->
                </div>
            </div>
        </div>

        <!-- Report Cards View -->
        <div id="reportCards" class="view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Report Cards</h2>
                    <button onclick="showView('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Back to Dashboard
                    </button>
                </div>

                <form id="reportCardForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Grade *</label>
                            <select id="reportCardGrade" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Grade</option>
                                <option value="PP1">PP1</option>
                                <option value="PP2">PP2</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="Grade 9">Grade 9</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Academic Year *</label>
                            <input type="number" id="reportCardYear" required min="2020" max="2030" value="2024" class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Term *</label>
                            <select id="reportCardTerm" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Term</option>
                                <option value="Term 1">Term 1</option>
                                <option value="Term 2">Term 2</option>
                                <option value="Term 3">Term 3</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Type of Exam *</label>
                            <select id="reportCardExamType" required class="w-full px-4 py-2 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="">Select Exam Type</option>
                                <option value="Midterm">Midterm</option>
                                <option value="Endterm">Endterm</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <button type="submit" class="bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-lg">
                            Generate Report Cards
                        </button>
                        <button type="button" onclick="viewReportCards()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg" style="display: none;" id="viewReportCardsBtn">
                            View Report Cards
                        </button>
                        <button type="button" onclick="printReportCards()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg" style="display: none;" id="printReportCardsBtn">
                            Print Report Cards
                        </button>
                    </div>
                </form>

                <div id="reportCardContent" class="hidden mt-8">
                    <!-- Report card content will be generated here -->
                </div>
            </div>
        </div>

        <!-- Print Area -->
        <div id="printArea" class="print-only">
            <!-- Print content will be inserted here -->
        </div>

        <!-- Success/Error Messages -->
        <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>
    </main>

    <script>
        // Data Storage
        let students = [];
        let teachers = [];
        let terms = [];
        let marks = [];

        // Load data from localStorage on startup
        function loadStoredData() {
            try {
                students = JSON.parse(localStorage.getItem('students') || '[]');
                teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
                terms = JSON.parse(localStorage.getItem('terms') || '[]');
                marks = JSON.parse(localStorage.getItem('marks') || '[]');
                console.log('Data loaded successfully:', {
                    students: students.length,
                    teachers: teachers.length,
                    terms: terms.length,
                    marks: marks.length
                });
            } catch (error) {
                console.error('Error loading stored data:', error);
                showMessage('Error loading stored data', 'error');
            }
        }

        // Grade and Learning Area Mappings
        const gradeMappings = {
            'PRE-PRIMARY': ['PP1', 'PP2'],
            'LOWER PRIMARY': ['Grade 1', 'Grade 2', 'Grade 3'],
            'UPPER PRIMARY': ['Grade 4', 'Grade 5', 'Grade 6'],
            'JUNIOR SCHOOL': ['Grade 7', 'Grade 8', 'Grade 9']
        };

        const learningAreas = {
            'PP1': ['Language Activities', 'Mathematical Activities', 'Environmental Activities', 'Creative Activities', 'Religious Activities'],
            'PP2': ['Language Activities', 'Mathematical Activities', 'Environmental Activities', 'Creative Activities', 'Religious Activities'],
            'Grade 1': ['English Language Activities', 'Kiswahili Language Activities', 'Indigenous Languages Activities', 'Mathematical Activities', 'Environmental Activities', 'Creative Activities', 'Religious Education Activities'],
            'Grade 2': ['English Language Activities', 'Kiswahili Language Activities', 'Indigenous Languages Activities', 'Mathematical Activities', 'Environmental Activities', 'Creative Activities', 'Religious Education Activities'],
            'Grade 3': ['English Language Activities', 'Kiswahili Language Activities', 'Indigenous Languages Activities', 'Mathematical Activities', 'Environmental Activities', 'Creative Activities', 'Religious Education Activities'],
            'Grade 4': ['English', 'Kiswahili', 'Mathematics', 'Religious Education', 'Science and Technology', 'Agriculture and Nutrition', 'Social Studies', 'Creative Arts'],
            'Grade 5': ['English', 'Kiswahili', 'Mathematics', 'Religious Education', 'Science and Technology', 'Agriculture and Nutrition', 'Social Studies', 'Creative Arts'],
            'Grade 6': ['English', 'Kiswahili', 'Mathematics', 'Religious Education', 'Science and Technology', 'Agriculture and Nutrition', 'Social Studies', 'Creative Arts'],
            'Grade 7': ['English (ENG 901)', 'Kiswahili (KIS 902)', 'Mathematics (MATH 903)', 'Integrated Science (INT-SCIE 905)', 'Agriculture and Nutrition (AGR 906)', 'Social Studies (SST 907)', 'Christian Religious Education (CRE 908)', 'Creative Arts and Sports (CAS 911)', 'Pre-technical Studies (PRE-TECH 912)'],
            'Grade 8': ['English (ENG 901)', 'Kiswahili (KIS 902)', 'Mathematics (MATH 903)', 'Integrated Science (INT-SCIE 905)', 'Agriculture and Nutrition (AGR 906)', 'Social Studies (SST 907)', 'Christian Religious Education (CRE 908)', 'Creative Arts and Sports (CAS 911)', 'Pre-technical Studies (PRE-TECH 912)'],
            'Grade 9': ['English (ENG 901)', 'Kiswahili (KIS 902)', 'Mathematics (MATH 903)', 'Integrated Science (INT-SCIE 905)', 'Agriculture and Nutrition (AGR 906)', 'Social Studies (SST 907)', 'Christian Religious Education (CRE 908)', 'Creative Arts and Sports (CAS 911)', 'Pre-technical Studies (PRE-TECH 912)']
        };

        // Utility Functions
        function showMessage(message, type = 'success') {
            const messageContainer = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-4 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white mb-4`;
            messageDiv.textContent = message;
            messageContainer.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        function showView(viewName) {
            // Hide all views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Show selected view
            document.getElementById(viewName).classList.remove('hidden');
            
            // Update statistics if returning to dashboard
            if (viewName === 'dashboard') {
                updateDashboardStats();
            }
        }

        function updateDashboardStats() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('totalTeachers').textContent = teachers.length;
        }

        // Grade Selection Functions - FIXED
        function updateGrades() {
            const section = document.getElementById('section').value;
            const gradeSelect = document.getElementById('grade');
            
            // Clear existing options
            gradeSelect.innerHTML = '<option value="">Select Grade</option>';
            
            if (section && gradeMappings[section]) {
                gradeMappings[section].forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = grade;
                    gradeSelect.appendChild(option);
                });
                console.log(`Updated grades for section: ${section}`, gradeMappings[section]);
            }
        }

        // Reset Functions
        function resetStudentForm() {
            document.getElementById('studentForm').reset();
            document.getElementById('grade').innerHTML = '<option value="">Select Grade</option>';
        }

        function resetTeacherForm() {
            document.getElementById('teacherForm').reset();
            document.getElementById('gradeSelector').classList.add('hidden');
            document.getElementById('subjectSelector').classList.add('hidden');
        }

        // Teacher Form Functions
        function toggleGradeSelector(checkbox) {
            const gradeSelector = document.getElementById('gradeSelector');
            if (checkbox.checked) {
                gradeSelector.classList.remove('hidden');
            } else {
                gradeSelector.classList.add('hidden');
            }
        }

        function toggleSubjectSelector(checkbox) {
            const subjectSelector = document.getElementById('subjectSelector');
            if (checkbox.checked) {
                subjectSelector.classList.remove('hidden');
                populateLearningAreas();
            } else {
                subjectSelector.classList.add('hidden');
            }
        }

        function populateLearningAreas() {
            const learningAreasContainer = document.getElementById('learningAreas');
            learningAreasContainer.innerHTML = '';
            
            // Get all unique learning areas
            const allAreas = new Set();
            Object.values(learningAreas).forEach(areas => {
                areas.forEach(area => allAreas.add(area));
            });
            
            allAreas.forEach(area => {
                const label = document.createElement('label');
                label.className = 'flex items-center';
                label.innerHTML = `
                    <input type="checkbox" value="${area}" class="learning-area mr-2">
                    <span class="dark:text-gray-300">${area}</span>
                `;
                learningAreasContainer.appendChild(label);
            });
        }

        // Form Submit Handlers - FIXED
        function handleStudentSubmit(e) {
            e.preventDefault();
            
            const admissionNumber = document.getElementById('admissionNumber').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const gender = document.getElementById('gender').value;
            const section = document.getElementById('section').value;
            const grade = document.getElementById('grade').value;
            const yearOfAdmission = document.getElementById('yearOfAdmission').value;
            
            // Validation
            if (!admissionNumber || !studentName || !gender || !section || !grade || !yearOfAdmission) {
                showMessage('Please fill all required fields!', 'error');
                return;
            }
            
            // Check for duplicate admission number
            if (students.find(s => s.admissionNumber === admissionNumber)) {
                showMessage('Admission number already exists!', 'error');
                return;
            }
            
            const student = {
                id: Date.now(),
                admissionNumber: admissionNumber,
                assessmentNumber: document.getElementById('assessmentNumber').value.trim(),
                name: studentName,
                gender: gender,
                section: section,
                grade: grade,
                yearOfAdmission: yearOfAdmission,
                registeredDate: new Date().toISOString()
            };
            
            students.push(student);
            localStorage.setItem('students', JSON.stringify(students));
            
            showMessage(`Learner ${student.name} successfully registered in ${student.grade}!`);
            resetStudentForm();
            updateDashboardStats();
            
            console.log('Student registered:', student);
            console.log('Total students:', students.length);
        }

        function handleTeacherSubmit(e) {
            e.preventDefault();
            
            const teacherName = document.getElementById('teacherName').value.trim();
            const roles = Array.from(document.querySelectorAll('.teacher-role:checked')).map(cb => cb.value);
            const learningAreasSelected = Array.from(document.querySelectorAll('.learning-area:checked')).map(cb => cb.value);
            
            // Validation
            if (!teacherName || roles.length === 0) {
                showMessage('Please enter teacher name and select at least one role!', 'error');
                return;
            }
            
            const teacher = {
                id: Date.now(),
                name: teacherName,
                roles: roles,
                facilitatingGrade: document.getElementById('facilitatingGrade').value,
                learningAreas: learningAreasSelected,
                registeredDate: new Date().toISOString()
            };
            
            teachers.push(teacher);
            localStorage.setItem('teachers', JSON.stringify(teachers));
            
            showMessage(`Facilitator ${teacher.name} successfully registered!`);
            resetTeacherForm();
            updateDashboardStats();
            
            console.log('Teacher registered:', teacher);
            console.log('Total teachers:', teachers.length);
        }

        function handleTermSubmit(e) {
            e.preventDefault();
            
            const termValue = document.getElementById('termSelect').value;
            const year = document.getElementById('termYear').value;
            const openingDate = document.getElementById('openingDate').value;
            const closingDate = document.getElementById('closingDate').value;
            
            if (!termValue || !year || !openingDate || !closingDate) {
                showMessage('Please fill all fields!', 'error');
                return;
            }
            
            // Check for duplicate term/year combination
            if (terms.find(t => t.term === termValue && t.year === year)) {
                showMessage('Term for this year already exists!', 'error');
                return;
            }
            
            const term = {
                id: Date.now(),
                term: termValue,
                year: year,
                openingDate: openingDate,
                closingDate: closingDate,
                createdDate: new Date().toISOString()
            };

            terms.push(term);
            localStorage.setItem('terms', JSON.stringify(terms));
            
            showMessage(`${term.term} ${term.year} dates saved successfully!`);
            document.getElementById('termForm').reset();
            displayExistingTerms();
            
            console.log('Term saved:', term);
        }

        function handleMarksheetSubmit(e) {
            e.preventDefault();
            
            const grade = document.getElementById('marksheetGrade').value;
            const year = document.getElementById('marksheetYear').value;
            const term = document.getElementById('marksheetTerm').value;
            const examType = document.getElementById('marksheetExamType').value;

            if (!grade || !year || !term || !examType) {
                showMessage('Please fill all fields!', 'error');
                return;
            }

            generateMarksheet(grade, year, term, examType);
        }

        function handleBroadsheetSubmit(e) {
            e.preventDefault();
            
            const grade = document.getElementById('broadsheetGrade').value;
            const year = document.getElementById('broadsheetYear').value;
            const term = document.getElementById('broadsheetTerm').value;
            const examType = document.getElementById('broadsheetExamType').value;

            if (!grade || !year || !term || !examType) {
                showMessage('Please fill all fields!', 'error');
                return;
            }

            generateBroadsheet(grade, year, term, examType);
        }

        function handleReportCardSubmit(e) {
            e.preventDefault();
            
            const grade = document.getElementById('reportCardGrade').value;
            const year = document.getElementById('reportCardYear').value;
            const term = document.getElementById('reportCardTerm').value;
            const examType = document.getElementById('reportCardExamType').value;

            if (!grade || !year || !term || !examType) {
                showMessage('Please fill all fields!', 'error');
                return;
            }

            generateReportCards(grade, year, term, examType);
        }

        // Grade List Functions
        function loadGradeList() {
            const selectedGrade = document.getElementById('gradeListSelector').value;
            if (!selectedGrade) {
                showMessage('Please select a grade', 'error');
                return;
            }
            
            const gradeStudents = students.filter(s => s.grade === selectedGrade);
            const tableBody = document.getElementById('gradeListTable');
            
            if (gradeStudents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 dark:text-gray-300">No students found in this grade</td></tr>';
            } else {
                tableBody.innerHTML = gradeStudents.map((student, index) => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${index + 1}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.admissionNumber}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.assessmentNumber || '-'}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.name}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.gender}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">________________</td>
                    </tr>
                `).join('');
            }
            
            document.getElementById('gradeListContent').classList.remove('hidden');
            showMessage(`Loaded ${gradeStudents.length} students from ${selectedGrade}`);
        }

        // System Functions
        function freshSystem() {
            if (confirm('Are you sure you want to reset the entire system? This will delete all data and cannot be undone.')) {
                localStorage.clear();
                students = [];
                teachers = [];
                terms = [];
                marks = [];
                showMessage('System has been reset successfully!');
                updateDashboardStats();
                displayExistingTerms();
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                showMessage('Logged out successfully!');
                showView('dashboard');
            }
        }

        // Grading Functions
        function getPerformanceLevel(mark) {
            if (mark >= 75) return 'EE';
            if (mark >= 50) return 'ME';
            if (mark >= 25) return 'AE';
            return 'BE';
        }

        function getAchievementLevel(mark) {
            if (mark >= 88) return 'AL8';
            if (mark >= 75) return 'AL7';
            if (mark >= 62) return 'AL6';
            if (mark >= 50) return 'AL5';
            if (mark >= 38) return 'AL4';
            if (mark >= 25) return 'AL3';
            if (mark >= 13) return 'AL2';
            return 'AL1';
        }

        function getPoints(achievementLevel) {
            const pointsMap = {
                'AL8': 8, 'AL7': 7, 'AL6': 6, 'AL5': 5,
                'AL4': 4, 'AL3': 3, 'AL2': 2, 'AL1': 1
            };
            return pointsMap[achievementLevel] || 1;
        }

        function getSubjectRemarks(performanceLevel) {
            const remarksMap = {
                'EE': 'Excellent performance. Keep up the excellent work!',
                'ME': 'Good performance. With more effort, you can achieve excellence.',
                'AE': 'Average performance. More practice and dedication needed.',
                'BE': 'Below expectations. Requires immediate attention and support.'
            };
            return remarksMap[performanceLevel] || 'Needs improvement';
        }

        function getTeacherInitials(teacherName) {
            if (!teacherName) return '';
            return teacherName.split(' ').map(name => name.charAt(0).toUpperCase()).join('.');
        }

        // Promotion Functions
        function loadStudentsForPromotion() {
            const fromGrade = document.getElementById('promoteFromGrade').value;
            if (!fromGrade) {
                showMessage('Please select a grade to promote from', 'error');
                return;
            }

            const studentsToPromote = students.filter(s => s.grade === fromGrade);
            const tableBody = document.getElementById('promotionTableBody');

            if (studentsToPromote.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 dark:text-gray-300">No students found in this grade</td></tr>';
            } else {
                tableBody.innerHTML = studentsToPromote.map(student => `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                            <input type="checkbox" class="promote-student" value="${student.id}">
                        </td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.admissionNumber}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.name}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.grade}</td>
                        <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.gender}</td>
                    </tr>
                `).join('');
            }

            document.getElementById('promotionStudentsList').classList.remove('hidden');
            showMessage(`Loaded ${studentsToPromote.length} students for promotion`);
        }

        function toggleAllPromoteSelection() {
            const selectAll = document.getElementById('selectAllPromote').checked;
            document.querySelectorAll('.promote-student').forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }

        function promoteSelectedStudents() {
            const selectedStudents = Array.from(document.querySelectorAll('.promote-student:checked')).map(cb => cb.value);
            const toGrade = document.getElementById('promoteToGrade').value;
            const year = document.getElementById('promoteYear').value;

            if (selectedStudents.length === 0) {
                showMessage('Please select students to promote', 'error');
                return;
            }

            if (!toGrade) {
                showMessage('Please select target grade', 'error');
                return;
            }

            selectedStudents.forEach(studentId => {
                const student = students.find(s => s.id == studentId);
                if (student) {
                    student.grade = toGrade;
                    student.yearOfAdmission = year;
                    
                    // Update section based on new grade
                    for (const [section, grades] of Object.entries(gradeMappings)) {
                        if (grades.includes(toGrade)) {
                            student.section = section;
                            break;
                        }
                    }
                }
            });

            localStorage.setItem('students', JSON.stringify(students));
            showMessage(`${selectedStudents.length} students promoted to ${toGrade} successfully!`);
            loadStudentsForPromotion();
        }

        function promoteAllStudents() {
            const fromGrade = document.getElementById('promoteFromGrade').value;
            const toGrade = document.getElementById('promoteToGrade').value;
            const year = document.getElementById('promoteYear').value;

            if (!fromGrade || !toGrade) {
                showMessage('Please select both from and to grades', 'error');
                return;
            }

            const studentsToPromote = students.filter(s => s.grade === fromGrade);
            
            if (studentsToPromote.length === 0) {
                showMessage('No students found in the selected grade', 'error');
                return;
            }

            studentsToPromote.forEach(student => {
                student.grade = toGrade;
                student.yearOfAdmission = year;
                
                // Update section based on new grade
                for (const [section, grades] of Object.entries(gradeMappings)) {
                    if (grades.includes(toGrade)) {
                        student.section = section;
                        break;
                    }
                }
            });

            localStorage.setItem('students', JSON.stringify(students));
            showMessage(`All ${studentsToPromote.length} students promoted from ${fromGrade} to ${toGrade} successfully!`);
            loadStudentsForPromotion();
        }

        // Term and Dates Functions
        function displayExistingTerms() {
            const container = document.getElementById('existingTerms');
            
            if (terms.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No terms configured yet.</p>';
                return;
            }

            container.innerHTML = terms.map(term => `
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h4 class="font-semibold dark:text-white">${term.term} ${term.year}</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Opening: ${new Date(term.openingDate).toLocaleDateString()}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-300">Closing: ${new Date(term.closingDate).toLocaleDateString()}</p>
                    <button onclick="deleteTerm(${term.id})" class="mt-2 text-red-600 hover:text-red-800 text-sm">Delete</button>
                </div>
            `).join('');
        }

        function deleteTerm(termId) {
            if (confirm('Are you sure you want to delete this term?')) {
                terms = terms.filter(t => t.id !== termId);
                localStorage.setItem('terms', JSON.stringify(terms));
                displayExistingTerms();
                showMessage('Term deleted successfully!');
            }
        }

        // Mark Entry Functions
        function loadLearningAreasForMarks() {
            const grade = document.getElementById('markEntryGrade').value;
            const learningAreaSelect = document.getElementById('markEntryLearningArea');
            
            learningAreaSelect.innerHTML = '<option value="">Select Learning Area</option>';
            
            if (grade && learningAreas[grade]) {
                learningAreas[grade].forEach(area => {
                    const option = document.createElement('option');
                    option.value = area;
                    option.textContent = area;
                    learningAreaSelect.appendChild(option);
                });
                document.getElementById('learningAreaSelection').classList.remove('hidden');
            } else {
                document.getElementById('learningAreaSelection').classList.add('hidden');
            }
        }

        function loadStudentsForMarks() {
            const grade = document.getElementById('markEntryGrade').value;
            const term = document.getElementById('markEntryTerm').value;
            const examType = document.getElementById('markEntryExamType').value;
            const learningArea = document.getElementById('markEntryLearningArea').value;
            const year = document.getElementById('markEntryYear').value;

            if (!grade || !term || !examType || !learningArea || !year) {
                showMessage('Please fill all fields before loading students', 'error');
                return;
            }

            const gradeStudents = students.filter(s => s.grade === grade);
            const tableBody = document.getElementById('markEntryTableBody');

            if (gradeStudents.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 dark:text-gray-300">No students found in this grade</td></tr>';
            } else {
                tableBody.innerHTML = gradeStudents.map((student, index) => {
                    // Check if marks already exist
                    const existingMark = marks.find(m => 
                        m.studentId === student.id && 
                        m.grade === grade && 
                        m.term === term && 
                        m.examType === examType && 
                        m.learningArea === learningArea &&
                        m.year === year
                    );

                    return `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${index + 1}</td>
                            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.admissionNumber}</td>
                            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2 dark:text-gray-300">${student.name}</td>
                            <td class="border border-gray-300 dark:border-gray-600 px-4 py-2">
                                <input type="number" min="0" max="100" value="${existingMark ? existingMark.mark : ''}" 
                                       class="mark-input w-full px-2 py-1 text-base border rounded" 
                                       data-student-id="${student.id}">
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            document.getElementById('markEntryTable').classList.remove('hidden');
            document.getElementById('submitMarksBtn').style.display = 'inline-block';
            showMessage(`Loaded ${gradeStudents.length} students for mark entry`);
        }

        function submitMarks() {
            const grade = document.getElementById('markEntryGrade').value;
            const term = document.getElementById('markEntryTerm').value;
            const examType = document.getElementById('markEntryExamType').value;
            const learningArea = document.getElementById('markEntryLearningArea').value;
            const year = document.getElementById('markEntryYear').value;

            const markInputs = document.querySelectorAll('.mark-input');
            let submittedCount = 0;

            markInputs.forEach(input => {
                const studentId = input.dataset.studentId;
                const mark = parseFloat(input.value);

                if (!isNaN(mark) && mark >= 0 && mark <= 100) {
                    // Remove existing mark if any
                    marks = marks.filter(m => !(
                        m.studentId == studentId && 
                        m.grade === grade && 
                        m.term === term && 
                        m.examType === examType && 
                        m.learningArea === learningArea &&
                        m.year === year
                    ));

                    // Add new mark
                    const markRecord = {
                        id: Date.now() + Math.random(),
                        studentId: parseInt(studentId),
                        grade,
                        term,
                        examType,
                        learningArea,
                        year,
                        mark,
                        performanceLevel: getPerformanceLevel(mark),
                        achievementLevel: getAchievementLevel(mark),
                        points: getPoints(getAchievementLevel(mark)),
                        submittedDate: new Date().toISOString()
                    };

                    marks.push(markRecord);
                    submittedCount++;
                }
            });

            localStorage.setItem('marks', JSON.stringify(marks));
            showMessage(`Marks for ${submittedCount} students submitted successfully!`);
            console.log('Marks submitted:', submittedCount);
        }

        // Marksheet Generation Functions
        function generateMarksheet(grade, year, term, examType) {
            const gradeStudents = students.filter(s => s.grade === grade);
            const gradeLearningAreas = learningAreas[grade] || [];

            if (gradeStudents.length === 0) {
                showMessage('No students found in this grade', 'error');
                return;
            }

            // Create marksheet content
            let marksheetHTML = generateMarksheetHeader(grade, year, term, examType);
            
            // Split students into pages (40 per page)
            const studentsPerPage = 40;
            const totalPages = Math.ceil(gradeStudents.length / studentsPerPage);

            for (let page = 0; page < totalPages; page++) {
                const startIndex = page * studentsPerPage;
                const endIndex = Math.min(startIndex + studentsPerPage, gradeStudents.length);
                const pageStudents = gradeStudents.slice(startIndex, endIndex);

                marksheetHTML += generateMarksheetPage(pageStudents, gradeLearningAreas, page + 1, totalPages, grade);
                
                if (page < totalPages - 1) {
                    marksheetHTML += '<div style="page-break-after: always;"></div>';
                }
            }

            marksheetHTML += '<div class="footer" style="margin-top: 20px; text-align: center; font-size: 10px; color: #666;">Jestine Naibei Digital Solution</div>';

            // Display and print
            document.getElementById('printArea').innerHTML = marksheetHTML;
            window.print();
            showMessage('Marksheet generated and sent to printer!');
        }

        function generateMarksheetHeader(grade, year, term, examType) {
            return `
                <div class="marksheet-header" style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                        <div style="width: 80px; height: 80px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <div style="width: 60px; height: 60px; background: #1e3a8a; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">LOGO</div>
                        </div>
                        <div>
                            <h1 style="margin: 0; font-size: 24px; color: #1e3a8a; font-weight: bold;">RAMA SDA SCHOOL</h1>
                            <p style="margin: 5px 0; font-size: 14px;">P.O. BOX 44-50201, CHEPTAIS</p>
                            <p style="margin: 5px 0; font-size: 12px; font-style: italic;">Motto: "In God We Can"</p>
                            <p style="margin: 5px 0; font-size: 12px;">ramasdaprimary@gmail.com</p>
                        </div>
                    </div>
                    <h2 style="margin: 15px 0 5px 0; font-size: 18px;">MARKSHEET</h2>
                    <p style="margin: 0; font-size: 14px;"><strong>Grade:</strong> ${grade} | <strong>Year:</strong> ${year} | <strong>Term:</strong> ${term} | <strong>Exam:</strong> ${examType}</p>
                </div>
            `;
        }

        function generateMarksheetPage(pageStudents, gradeLearningAreas, pageNum, totalPages, grade) {
            const maleCount = pageStudents.filter(s => s.gender === 'Male').length;
            const femaleCount = pageStudents.filter(s => s.gender === 'Female').length;

            let html = `
                <div class="marksheet-page">
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 15px;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="border: 1px solid #000; padding: 8px; text-align: left;">S/No</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: left;">Admission No.</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: left;">Assessment No.</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: left;">Name</th>
                                    <th style="border: 1px solid #000; padding: 8px; text-align: left;">Gender</th>`;

            gradeLearningAreas.forEach(area => {
                html += `<th style="border: 1px solid #000; padding: 8px; text-align: center; writing-mode: vertical-lr; max-width: 30px;">${area}</th>`;
            });

            html += `</tr></thead><tbody>`;

            pageStudents.forEach((student, index) => {
                const serialNo = ((pageNum - 1) * 40) + index + 1;
                html += `
                    <tr>
                        <td style="border: 1px solid #000; padding: 6px;">${serialNo}</td>
                        <td style="border: 1px solid #000; padding: 6px;">${student.admissionNumber}</td>
                        <td style="border: 1px solid #000; padding: 6px;">${student.assessmentNumber || '-'}</td>
                        <td style="border: 1px solid #000; padding: 6px;">${student.name}</td>
                        <td style="border: 1px solid #000; padding: 6px;">${student.gender}</td>`;

                gradeLearningAreas.forEach(area => {
                    html += `<td style="border: 1px solid #000; padding: 6px; text-align: center;"></td>`;
                });

                html += `</tr>`;
            });

            html += `
                </tbody>
                </table>
                </div>
                <div style="margin-top: 15px; font-size: 12px;">
                    <p><strong>Page ${pageNum} of ${totalPages}</strong></p>
                    <p><strong>Male:</strong> ${maleCount} | <strong>Female:</strong> ${femaleCount} | <strong>Total:</strong> ${pageStudents.length}</p>
                </div>
                </div>
            `;

            return html;
        }

        // Broadsheet Functions
        function generateBroadsheet(grade, year, term, examType) {
            const gradeStudents = students.filter(s => s.grade === grade);
            const gradeLearningAreas = learningAreas[grade] || [];

            if (gradeStudents.length === 0) {
                showMessage('No students found in this grade', 'error');
                return;
            }

            // Calculate student results
            const studentResults = gradeStudents.map(student => {
                const studentMarks = marks.filter(m => 
                    m.studentId === student.id && 
                    m.grade === grade && 
                    m.term === term && 
                    m.examType === examType &&
                    m.year === year
                );

                let totalMarks = 0;
                let totalPoints = 0;
                let subjectCount = 0;

                const subjectResults = {};

                gradeLearningAreas.forEach(area => {
                    const mark = studentMarks.find(m => m.learningArea === area);
                    if (mark) {
                        subjectResults[area] = {
                            mark: mark.mark,
                            performanceLevel: mark.performanceLevel,
                            achievementLevel: mark.achievementLevel,
                            points: mark.points
                        };
                        totalMarks += mark.mark;
                        totalPoints += mark.points;
                        subjectCount++;
                    } else {
                        subjectResults[area] = {
                            mark: 0,
                            performanceLevel: 'BE',
                            achievementLevel: 'AL1',
                            points: 1
                        };
                        totalPoints += 1;
                        subjectCount++;
                    }
                });

                const averageMark = subjectCount > 0 ? totalMarks / subjectCount : 0;
                const finalPerformanceLevel = getPerformanceLevel(averageMark);
                const finalAchievementLevel = getAchievementLevel(averageMark);

                return {
                    student,
                    subjectResults,
                    totalMarks,
                    averageMark,
                    totalPoints,
                    finalPerformanceLevel,
                    finalAchievementLevel
                };
            });

            // Sort by total points (descending) for ranking
            studentResults.sort((a, b) => b.totalPoints - a.totalPoints);
            
            // Add rankings
            studentResults.forEach((result, index) => {
                result.ranking = index + 1;
            });

            // Generate broadsheet HTML
            const broadsheetHTML = generateBroadsheetHTML(studentResults, gradeLearningAreas, grade, year, term, examType);
            
            document.getElementById('broadsheetContent').innerHTML = broadsheetHTML;
            document.getElementById('broadsheetContent').classList.remove('hidden');
            document.getElementById('printBroadsheetBtn').style.display = 'inline-block';
            showMessage('Broadsheet generated successfully!');
        }

        function generateBroadsheetHTML(studentResults, gradeLearningAreas, grade, year, term, examType) {
            let html = `
                <div class="broadsheet">
                    <div class="header" style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                        <h1 style="color: #1e3a8a; margin: 0;">RAMA SDA SCHOOL</h1>
                        <p style="margin: 5px 0;">P.O. BOX 44-50201, CHEPTAIS</p>
                        <h2 style="margin: 10px 0;">BROADSHEET ANALYSIS</h2>
                        <p><strong>Grade:</strong> ${grade} | <strong>Year:</strong> ${year} | <strong>Term:</strong> ${term} | <strong>Exam:</strong> ${examType}</p>
                    </div>

                    <div style="overflow-x: auto; margin-bottom: 30px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="border: 1px solid #000; padding: 6px;">S/No</th>
                                    <th style="border: 1px solid #000; padding: 6px;">Adm No.</th>
                                    <th style="border: 1px solid #000; padding: 6px;">Ass No.</th>
                                    <th style="border: 1px solid #000; padding: 6px;">Name</th>
                                    <th style="border: 1px solid #000; padding: 6px;">Gender</th>`;

            gradeLearningAreas.forEach(area => {
                html += `<th style="border: 1px solid #000; padding: 6px; text-align: center;">${area.substring(0, 10)}...</th>`;
            });

            html += `
                                    <th style="border: 1px solid #000; padding: 6px;">Total</th>
                                    <th style="border: 1px solid #000; padding: 6px;">Average</th>
                                    <th style="border: 1px solid #000; padding: 6px;">Points</th>
                                    <th style="border: 1px solid #000; padding: 6px;">Final PL</th>
                                    <th style="border: 1px solid #000; padding: 6px;">Final AL</th>
                                    <th style="border: 1px solid #000; padding: 6px;">Rank</th>
                                </tr>
                            </thead>
                            <tbody>`;

            studentResults.forEach((result, index) => {
                html += `
                    <tr>
                        <td style="border: 1px solid #000; padding: 4px;">${index + 1}</td>
                        <td style="border: 1px solid #000; padding: 4px;">${result.student.admissionNumber}</td>
                        <td style="border: 1px solid #000; padding: 4px;">${result.student.assessmentNumber || '-'}</td>
                        <td style="border: 1px solid #000; padding: 4px;">${result.student.name}</td>
                        <td style="border: 1px solid #000; padding: 4px;">${result.student.gender}</td>`;

                gradeLearningAreas.forEach(area => {
                    const subject = result.subjectResults[area];
                    html += `<td style="border: 1px solid #000; padding: 4px; text-align: center;">${subject.mark} (${subject.achievementLevel})</td>`;
                });

                html += `
                        <td style="border: 1px solid #000; padding: 4px; text-align: center;">${result.totalMarks.toFixed(1)}</td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: center;">${result.averageMark.toFixed(1)}</td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: center;">${result.totalPoints}</td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: center;">${result.finalPerformanceLevel}</td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: center;">${result.finalAchievementLevel}</td>
                        <td style="border: 1px solid #000; padding: 4px; text-align: center;">${result.ranking}</td>
                    </tr>`;
            });

            html += `</tbody></table></div>`;
            html += `<div style="margin-top: 20px; text-align: center; font-size: 10px; color: #666;">Jestine Naibei Digital Solution</div>`;
            html += `</div>`;

            return html;
        }

        function printBroadsheet() {
            const content = document.getElementById('broadsheetContent').innerHTML;
            document.getElementById('printArea').innerHTML = content;
            window.print();
        }

        // Report Card Functions
        function generateReportCards(grade, year, term, examType) {
            const gradeStudents = students.filter(s => s.grade === grade);
            
            if (gradeStudents.length === 0) {
                showMessage('No students found in this grade', 'error');
                return;
            }

            const reportCardsHTML = gradeStudents.map(student => generateSingleReportCard(student, grade, year, term, examType)).join('<div style="page-break-after: always;"></div>');
            
            document.getElementById('reportCardContent').innerHTML = reportCardsHTML;
            document.getElementById('reportCardContent').classList.remove('hidden');
            document.getElementById('viewReportCardsBtn').style.display = 'inline-block';
            document.getElementById('printReportCardsBtn').style.display = 'inline-block';
            showMessage(`Generated ${gradeStudents.length} report cards!`);
        }

        function generateSingleReportCard(student, grade, year, term, examType) {
            const gradeLearningAreas = learningAreas[grade] || [];
            const studentMarks = marks.filter(m => 
                m.studentId === student.id && 
                m.grade === grade && 
                m.term === term && 
                m.year === year
            );

            // Get term dates
            const termData = terms.find(t => t.term === term && t.year === year);
            const openingDate = termData ? new Date(termData.openingDate).toLocaleDateString() : '';
            const closingDate = termData ? new Date(termData.closingDate).toLocaleDateString() : '';

            let totalMarks = 0;
            let totalPoints = 0;
            let subjectCount = 0;

            const subjectRows = gradeLearningAreas.map(area => {
                const midtermMark = studentMarks.find(m => m.learningArea === area && m.examType === 'Midterm');
                const endtermMark = studentMarks.find(m => m.learningArea === area && m.examType === 'Endterm');
                
                let displayMark, performanceLevel, achievementLevel, points, teacherInitials, remarks;

                if (examType === 'Midterm' && midtermMark) {
                    displayMark = midtermMark.mark;
                    performanceLevel = midtermMark.performanceLevel;
                    achievementLevel = midtermMark.achievementLevel;
                    points = midtermMark.points;
                } else if (examType === 'Endterm') {
                    if (midtermMark && endtermMark) {
                        // Average of midterm and endterm
                        displayMark = (midtermMark.mark + endtermMark.mark) / 2;
                        performanceLevel = getPerformanceLevel(displayMark);
                        achievementLevel = getAchievementLevel(displayMark);
                        points = getPoints(achievementLevel);
                    } else if (endtermMark) {
                        displayMark = endtermMark.mark;
                        performanceLevel = endtermMark.performanceLevel;
                        achievementLevel = endtermMark.achievementLevel;
                        points = endtermMark.points;
                    } else {
                        displayMark = 0;
                        performanceLevel = 'BE';
                        achievementLevel = 'AL1';
                        points = 1;
                    }
                } else {
                    displayMark = 0;
                    performanceLevel = 'BE';
                    achievementLevel = 'AL1';
                    points = 1;
                }

                // Get subject teacher
                const subjectTeacher = teachers.find(t => t.learningAreas && t.learningAreas.includes(area));
                teacherInitials = subjectTeacher ? getTeacherInitials(subjectTeacher.name) : '';
                remarks = getSubjectRemarks(performanceLevel);

                totalMarks += displayMark;
                totalPoints += points;
                subjectCount++;

                return `
                    <tr>
                        <td style="border: 1px solid #000; padding: 6px;">${area}</td>
                        <td style="border: 1px solid #000; padding: 6px; text-align: center;">${displayMark.toFixed(1)}%</td>
                        <td style="border: 1px solid #000; padding: 6px; text-align: center;">${performanceLevel}</td>
                        <td style="border: 1px solid #000; padding: 6px; text-align: center;">${achievementLevel}</td>
                        <td style="border: 1px solid #000; padding: 6px; text-align: center;">${points}</td>
                        <td style="border: 1px solid #000; padding: 6px; text-align: center;">${teacherInitials}</td>
                        <td style="border: 1px solid #000; padding: 6px; font-size: 10px;">${remarks}</td>
                    </tr>
                `;
            }).join('');

            const averageMark = subjectCount > 0 ? totalMarks / subjectCount : 0;
            const finalPerformanceLevel = getPerformanceLevel(averageMark);
            const finalAchievementLevel = getAchievementLevel(averageMark);

            // Get class teacher
            const classTeacher = teachers.find(t => t.roles && t.roles.includes('GRADE FACILITATOR') && t.facilitatingGrade === grade);
            const classTeacherName = classTeacher ? classTeacher.name : 'Class Teacher';

            // Get HOI
            const hoi = teachers.find(t => t.roles && t.roles.includes('HEAD OF INSTITUTION'));
            const hoiName = hoi ? hoi.name : 'Head of Institution';

            // Generate comments
            const classTeacherComment = generateClassTeacherComment(finalPerformanceLevel, averageMark);
            const hoiComment = generateHOIComment(finalPerformanceLevel);

            return `
                <div class="report-card" style="width: 210mm; min-height: 297mm; margin: 0 auto; padding: 20mm; font-family: Arial, sans-serif; font-size: 12px; background: white;">
                    <!-- Header -->
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                            <div style="width: 80px; height: 80px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <div style="width: 60px; height: 60px; background: #1e3a8a; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">LOGO</div>
                            </div>
                            <div>
                                <h1 style="margin: 0; font-size: 24px; color: #1e3a8a; font-weight: bold;">RAMA SDA SCHOOL</h1>
                                <p style="margin: 5px 0; font-size: 14px;">P.O. BOX 44-50201, CHEPTAIS</p>
                                <p style="margin: 5px 0; font-size: 12px; font-style: italic;">Motto: "In God We Can"</p>
                                <p style="margin: 5px 0; font-size: 12px;">ramasdaprimary@gmail.com</p>
                            </div>
                        </div>
                        <h2 style="margin: 15px 0 5px 0; font-size: 18px;">LEARNER PROGRESS REPORT</h2>
                    </div>

                    <!-- Student Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <p><strong>Name:</strong> ${student.name}</p>
                            <p><strong>Admission No:</strong> ${student.admissionNumber}</p>
                            <p><strong>Assessment No:</strong> ${student.assessmentNumber || 'N/A'}</p>
                            <p><strong>Gender:</strong> ${student.gender}</p>
                        </div>
                        <div>
                            <p><strong>Grade:</strong> ${grade}</p>
                            <p><strong>Academic Year:</strong> ${year}</p>
                            <p><strong>Term:</strong> ${term}</p>
                            <p><strong>Class Teacher:</strong> ${classTeacherName}</p>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background-color: #f5f5f5;">
                                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Learning Area</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Percentage</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Performance Level</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Achievement Level</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Points</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Teacher Initials</th>
                                <th style="border: 1px solid #000; padding: 8px; text-align: center;">Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${subjectRows}
                        </tbody>
                    </table>

                    <!-- Summary -->
                    <div style="background-color: #f9f9f9; padding: 15px; border: 1px solid #ccc; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                            <div>
                                <p><strong>Total Marks:</strong> ${totalMarks.toFixed(1)}</p>
                                <p><strong>Average Mark:</strong> ${averageMark.toFixed(1)}%</p>
                            </div>
                            <div>
                                <p><strong>Total Points:</strong> ${totalPoints}</p>
                                <p><strong>Final Performance Level:</strong> ${getFullPerformanceLevel(finalPerformanceLevel)}</p>
                            </div>
                            <div>
                                <p><strong>Final Achievement Level:</strong> ${finalAchievementLevel}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Comments -->
                    <div style="margin-bottom: 30px;">
                        <div style="margin-bottom: 15px;">
                            <p><strong>Class Teacher's Comment:</strong></p>
                            <p style="border: 1px solid #ccc; padding: 10px; min-height: 40px;">${classTeacherComment}</p>
                        </div>
                        <div>
                            <p><strong>Head of Institution's Comment:</strong></p>
                            <p style="border: 1px solid #ccc; padding: 10px; min-height: 40px;">${hoiComment}</p>
                        </div>
                    </div>

                    <!-- Signatures -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <p><strong>Class Teacher's Signature:</strong></p>
                            <div style="border-bottom: 1px solid #000; height: 30px; margin-bottom: 5px;"></div>
                            <p><strong>Date:</strong> ________________</p>
                        </div>
                        <div>
                            <p><strong>Parent's Signature:</strong></p>
                            <div style="border-bottom: 1px solid #000; height: 30px; margin-bottom: 5px;"></div>
                            <p><strong>Date:</strong> ________________</p>
                        </div>
                        <div>
                            <p><strong>Head of Institution's Signature:</strong></p>
                            <div style="border-bottom: 1px solid #000; height: 30px; margin-bottom: 5px;"></div>
                            <p><strong>Date:</strong> ________________</p>
                        </div>
                    </div>

                    <!-- Term Dates -->
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                        <p><strong>Term Opening Date:</strong> ${openingDate}</p>
                        <p><strong>Term Closing Date:</strong> ${closingDate}</p>
                    </div>

                    <!-- Footer -->
                    <div style="text-align: center; font-size: 10px; color: #666; border-top: 1px solid #ccc; padding-top: 10px;">
                        Jestine Naibei Digital Solution
                    </div>
                </div>
            `;
        }

        function getFullPerformanceLevel(pl) {
            const fullNames = {
                'EE': 'EXCEEDING EXPECTATIONS',
                'ME': 'MEETING EXPECTATIONS', 
                'AE': 'APPROACHING EXPECTATIONS',
                'BE': 'BELOW EXPECTATIONS'
            };
            return fullNames[pl] || pl;
        }

        function generateClassTeacherComment(performanceLevel, averageMark) {
            if (performanceLevel === 'EE') {
                return `Excellent performance! ${averageMark.toFixed(1)}% average shows exceptional understanding. Keep up the outstanding work and continue striving for excellence.`;
            } else if (performanceLevel === 'ME') {
                return `Good performance with ${averageMark.toFixed(1)}% average. Shows solid understanding of concepts. With continued effort, can achieve excellence.`;
            } else if (performanceLevel === 'AE') {
                return `Shows potential with ${averageMark.toFixed(1)}% average. Needs more practice and focus to meet expectations. Encourage consistent study habits.`;
            } else {
                return `Requires immediate attention. ${averageMark.toFixed(1)}% average indicates need for extra support. Regular practice and parental involvement recommended.`;
            }
        }

        function generateHOIComment(performanceLevel) {
            const comments = {
                'EE': 'Exceptional student. A role model for others. Continue nurturing this talent.',
                'ME': 'Good progress shown. With dedication, can achieve greater heights.',
                'AE': 'Satisfactory progress. Encouragement and support will help improve performance.',
                'BE': 'Needs special attention and support. Parent-teacher collaboration essential.'
            };
            return comments[performanceLevel] || 'Keep working hard.';
        }

        function viewReportCards() {
            document.getElementById('reportCardContent').classList.remove('hidden');
        }

        function printReportCards() {
            const content = document.getElementById('reportCardContent').innerHTML;
            document.getElementById('printArea').innerHTML = content;
            window.print();
        }

        // Initialize Application
        function initializeApp() {
            console.log('Initializing Rama SDA School Exam Management System...');
            
            // Load stored data
            loadStoredData();
            
            // Update dashboard statistics
            updateDashboardStats();
            
            // Display existing terms
            displayExistingTerms();
            
            // Set up form event listeners
            const studentForm = document.getElementById('studentForm');
            if (studentForm) {
                studentForm.addEventListener('submit', handleStudentSubmit);
            }
            
            const teacherForm = document.getElementById('teacherForm');
            if (teacherForm) {
                teacherForm.addEventListener('submit', handleTeacherSubmit);
            }
            
            const termForm = document.getElementById('termForm');
            if (termForm) {
                termForm.addEventListener('submit', handleTermSubmit);
            }
            
            const marksheetForm = document.getElementById('marksheetForm');
            if (marksheetForm) {
                marksheetForm.addEventListener('submit', handleMarksheetSubmit);
            }
            
            const broadsheetForm = document.getElementById('broadsheetForm');
            if (broadsheetForm) {
                broadsheetForm.addEventListener('submit', handleBroadsheetSubmit);
            }
            
            const reportCardForm = document.getElementById('reportCardForm');
            if (reportCardForm) {
                reportCardForm.addEventListener('submit', handleReportCardSubmit);
            }
            
            // Populate current term in dashboard if available
            if (terms.length > 0) {
                const latestTerm = terms[terms.length - 1];
                document.getElementById('currentTerm').textContent = `${latestTerm.term} ${latestTerm.year}`;
            }
            
            console.log('System initialized successfully');
            console.log('Students loaded:', students.length);
            console.log('Teachers loaded:', teachers.length);
            console.log('Terms loaded:', terms.length);
            console.log('Marks loaded:', marks.length);
            
            showMessage('System initialized successfully!', 'success');
        }

        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
